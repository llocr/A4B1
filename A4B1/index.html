<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>A4B1</title>

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© ê°€ì ¸ì˜¤ê¸° -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- ì œì´ì¿¼ë¦¬ ê°€ì ¸ì˜¤ê¸° -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- main.css ìŠ¤íƒ€ì¼ì‹œíŠ¸ ê°€ì ¸ì˜¤ê¸° -->
    <link rel="stylesheet" href="main.css" />

    <script type="module">
        // Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebase êµ¬ì„± ì •ë³´ ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCwpweAcn_6QptJ76XSG5A19p-mMjOjAAE",
            authDomain: "a4b1-f4ba4.firebaseapp.com",
            projectId: "a4b1-f4ba4",
            storageBucket: "a4b1-f4ba4.appspot.com",
            messagingSenderId: "166828669253",
            appId: "1:166828669253:web:e17f765e7a791e34a9262c",
            measurementId: "G-Q766YQ7X7K"
        };

        // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firebaseì—ì„œ User ë°ì´í„° ê°€ì ¸ì™€ì„œ ë©¤ë²„ì¹´ë“œ ìƒì„±
        let docs = await getDocs(collection(db, "User"));
        docs.forEach((doc) => {
            let row = doc.data();

            let id = doc.id;
            let image = row['image'];
            let title = row['title'];
            let name = row['name'];
            let mbti = row['mbti'];

            let temp_html = `<div class="member-card" data-member-id="${id}" data-bs-toggle="modal" data-bs-target="#myModal">
                    <div class="card h-100">
                        <div class="">
                            <img src="${image}"
                            class="card-img-top">
                        </div>
                        
                        <div class="card-body">
                            <h5 class="card-title"><span id="title">${title}</span></h5>
                            <p class="card-text">ì´ë¦„ : <span id="name">${name}</span></p>
                            <p class="card-text">MBTI : <span id="mbti">${mbti}</span></p>
                        </div>
                    </div>
                </div>`;
            $('#card').append(temp_html);
        });

        // ëª¨ë‹¬ ì—´ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        $('#myModal').on('shown.bs.modal', async function (event) {
            // ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œ(ë©¤ë²„ ì¹´ë“œ) ê°€ì ¸ì˜¤ê¸°
            let memberCard = $(event.relatedTarget);

            // data-member-id ì†ì„± ê°’ ê°€ì ¸ì˜¤ê¸°
            let memberId = memberCard.data('member-id');

            // Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            let docs = await getDocs(collection(db, "User"));

            // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ëŒ“ê¸€ì„ ë¹„ì›Œì¤Œ
            $('#modal-comments').empty();

            docs.forEach((doc) => {
                let row = doc.data();
                let userId = doc.id;

                if (userId == memberId) {
                    let title = row['title'];
                    let image = row['image'];
                    let name = row['name'];
                    let mbti = row['mbti'];
                    let strengths = row['strengths'];
                    let weakness = row['weakness'];
                    let style = row['style'];
                    let goal = row['goal'];
                    let blog = row['blog'];

                    let image_temp_html = `
                    <img src="${image}" class="img-thumbnail" width="500px" />
                    `;

                    $('#image-box').empty();
                    $('#image-box').append(image_temp_html);

                    // ëª¨ë‹¬ì— ë°ì´í„° ì ìš©
                    $('#exampleModalLabel').text(title); // ì œëª© ì ìš©
                    $('#name').text(name); // ì´ë¦„ ì ìš©
                    $('#mbti').text(mbti); // MBTI ì ìš©
                    $('#strengths').text(strengths); // ì¥ì  ì ìš©
                    $('#weakness').text(weakness); // ë‹¨ì  ì ìš©
                    $('#style').text(style); // í˜‘ì—… ìŠ¤íƒ€ì¼ ì ìš©
                    $('#goal').text(goal); // ìµœì¢… ëª©í‘œ ì ìš©
                    $('#blog').text(blog); // ë¸”ë¡œê·¸ ì£¼ì†Œ ì ìš©

                    //ëŒ“ê¸€ë‹¬ê¸° ë²„íŠ¼ì— ì•„ì´ë””ê°’ì£¼ê¸°
                    $("#write-comment").attr("data-commentId", userId);
                }
            });

            // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
            let docs2 = await getDocs(collection(db, "Comments"));
            docs2.forEach((doc) => {
                let row = doc.data();

                let commentId = doc.id;
                let nickname = row['nickname'];
                let password = row['password'];
                let comment = row['comment'];

                if (memberId == row['parentId']) {
                    let temp_html = `
            <div class="d-flex text-body-secondary pt-3">
                <svg class="bd-placeholder-img flex-shrink-0 me-2 rounded" width="32" height="32" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: 32x32" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#007bff"></rect><text x="50%" y="50%" fill="#007bff" dy=".3em">32x32</text></svg>
                <div class="pb-3 mb-0 small lh-sm border-bottom w-100">
                <div class="d-flex justify-content-between">
                    <strong class="text-gray-dark">${nickname}</strong>
                    <a class="deleteBtn" href="#" data-id="${commentId}" data-password="${password}">ì‚­ì œí•˜ê¸°</a>
                </div>
                <span class="d-block">${comment}</span>
                </div>
            </div>`;
                    $('#modal-comments').append(temp_html);
                }
            });
        });

        //ëŒ“ê¸€ë‹¬ê¸° íŒì—… ë›°ìš°ê¸°, ë‹«ê¸° + saveBtnì— idê°’ ë¶€ì—¬
        $("#write-comment").click(function () {
            let userId = $(this).attr("data-commentId");
            $("#saveBtn").attr("data-saveId", userId);
            $("#comment-box").show();
        });

        $(".close").click(function () {
            $("#comment-box").hide();
        });

        //ëŒ“ê¸€ ì‘ì„± í›„ ì €ì¥
        $("#saveBtn").click(async function (event) {
            let userId = $(this).attr("data-saveId");
            let nickname = $("#nickname").val();
            let password = $("#password").val();
            let comment = $("#comment").val();

            if (nickname === '' || password === '' || comment === '') { //ë°ì´í„° ì…ë ¥ í™•ì¸
                alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            } else {
                let doc = {
                    'parentId': userId,
                    'nickname': nickname,
                    'password': password,
                    'comment': comment
                }
                await addDoc(collection(db, "Comments"), doc);
                alert('ì €ì¥ ì™„ë£Œ!');
                window.location.reload();
            }
        });

        //ëŒ“ê¸€ ì‚­ì œ íŒì—… ì—´ê³  ë‹«ê¸°
        $(document).on("click", ".deleteBtn", async function () {
            let commentId = $(this).attr("data-id");
            let password = $(this).attr("data-password");
            $("#deleteBtn").attr("data-id", commentId);
            $("#deleteBtn").attr("data-password", password);
            $("#delete-box").show();
        });

        $(".close").click(function () {
            $("#delete-box").hide();
        });

        //ëŒ“ê¸€ ì‚­ì œí•˜ê¸°
        $("#deleteBtn").click(async function () {
            let commentId = $(this).attr("data-id");
            let password = $(this).attr("data-password");
            let checkPassword = $("#check-password").val();

            if (checkPassword != password) { //ë°ì´í„° ì…ë ¥ í™•ì¸
                alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì œëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            } else {
                await deleteDoc(doc(db, "Comments", commentId));
                alert('ì‚­ì œ ì™„ë£Œ!');
                window.location.reload();
            }
        });
    </script>
</head>


<style>
    /* íŒ€ì†Œê°œdiv style */
    .box1 {
        width: 800px;
        margin: 20px auto 0px auto;
        border: 2px solid gray;
        border-radius: 20px;
        padding: 40px;
    }

    .text-body-emphasis {
        text-align: center;
        font-size: 40px;
    }

    .lead {
        text-align: center;
    }

    /* ëŒ“ê¸€ */
    .comment-box {
        display: none;
        position: absolute;
        padding: 3rem;
        border-radius: 1rem;
        background: coral;
    }
</style>

<body>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">ì œëª©</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="
                display: flex;
                justify-content: center;
                align-items: center;">

                    <!-- ëŒ“ê¸€ íŒì—… -->
                    <div id="comment-box" class="comment-box">
                        <div class="mb-3">
                            <input type="email" class="form-control" id="nickname" placeholder="ë‹‰ë„¤ì„">
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="comment" rows="3" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                        <div>
                            <button id="saveBtn" data-saveId="${}">ì €ì¥</button>
                            <button class="close">ë‹«ê¸°</button>
                        </div>
                    </div>

                    <!-- ì‚­ì œ íŒì—… -->
                    <div id="delete-box" class="comment-box">
                        <div class="mb-3">
                            <input type="email" class="form-control" id="check-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                        </div>
                        <div>
                            <button id="deleteBtn">ì‚­ì œ</button>
                            <button class="close">ë‹«ê¸°</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6" id="image-box"></div>
                        <div class="col-md-6" id="table-box">
                            <table class="table table-striped">
                                <tr>
                                    <th scope="row">ì´ë¦„</th>
                                    <td id="name">${name}</td>
                                </tr>
                                <tr>
                                    <th scope="row">MBTI</th>
                                    <td id="mbti">${mbti}</td>
                                </tr>
                                <tr>
                                    <th scope="row">ì¥ì </th>
                                    <td id="strengths">${strengths}</td>
                                </tr>
                                <tr>
                                    <th scope="row">ë‹¨ì </th>
                                    <td id="weakness">${weakness}</td>
                                </tr>
                                <tr>
                                    <th scope="row">í˜‘ì—… ìŠ¤íƒ€ì¼</th>
                                    <td id="style">${style}</td>
                                </tr>
                                <tr>
                                    <th scope="row">ìµœì¢… ëª©í‘œ</th>
                                    <td id="goal">${goal}</td>
                                </tr>
                                <tr>
                                    <th scope="row">ë¸”ë¡œê·¸ ì£¼ì†Œ</th>
                                    <td id="blog">${blog}</td>
                                </tr>
                            </table>
                        </div>
                        <div>
                            <!-- ëŒ“ê¸€ ë¶€ë¶„ div -->
                            <div>
                                <button id="write-comment" data-commentId="${}">ëŒ“ê¸€ë‹¬ê¸°</button>
                            </div>
                            <div id="modal-comments" class="my-3 p-3 bg-body rounded shadow-sm">
                                <h6 class="border-bottom pb-2 mb-0">ëŒ“ê¸€</h6>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="mytitle">
        <h1>A4B1ì„ ì†Œê°œ í•©ë‹ˆë‹¤.</h1>
    </header>

    <div>
        <div>
            <div>
                <!-- íŒ€ ì†Œê°œ ì¹¸ -->


                <div>
                    <!-- íŒ€ì†Œê°œdiv -->
                    <h1 class="text-body-emphasis">A4B1 ìš°ë¦¬ íŒ€ì˜ íŠ¹ë³„í•œ ì  </h1>

                    <div class="box1">

                        <p class="lead">
                            ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦ë‚¨ì 4ëª… ğŸ‘©ì—¬ì 1ëª…
                        </p>
                        <p class="lead">
                            ğŸ˜³ë‚´í–¥í˜• 4ëª… ğŸ˜ì™¸í–¥í˜• 1ëª…
                        </p>
                        <p class="lead">
                            ğŸ…°ï¸Aí˜• 4ëª… ğŸ…±ï¸Bí˜• 1ëª…
                        </p>
                    </div>
                </div>

            </div>

            <div class="member-card-box">
                <div id="card" class="row row-cols-1 row-cols-md-5 g-5">
                    <!-- member-cards -->
                </div>

            </div>
        </div>

        <footer class="capyft">
            <p calss="footname">Â© 2024 A4B1 team miniproject! thank you!</p>
        </footer>

</body>

</html>